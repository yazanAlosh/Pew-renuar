<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>חיפוש פריט / מק״ט + רנואר</title>
  <style>
    :root{--blue:#007bff;--blue2:#0056b3;--text:#222;--muted:#666;--bg:#ffffff;--card:#fff;--radius:12px}
    *{box-sizing:border-box}html,body{margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:var(--bg);color:var(--text);line-height:1.5}
    header{background:linear-gradient(90deg,var(--blue),var(--blue2));color:#fff;text-align:center;padding:16px 20px;box-shadow:0 2px 10px rgba(0,0,0,.12)}
    header h1{margin:6px 0 0;font-size:clamp(18px,2.6vw,26px)}
    .wrap{max-width:980px;margin:18px auto;padding:12px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.08);padding:clamp(14px,3vw,24px);margin-bottom:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:stretch}
    input[type=text]{flex:1;min-width:230px;padding:12px;border:1px solid #dcdcdc;border-radius:10px;font-size:16px;outline:0;box-shadow:inset 0 2px 4px rgba(0,0,0,.03)}
    input[type=text]:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(0,123,255,.12), inset 0 2px 4px rgba(0,0,0,.03)}
    button{background:var(--blue);color:#fff;border:0;border-radius:10px;padding:12px 18px;font-size:16px;font-weight:600;cursor:pointer;box-shadow:0 6px 16px rgba(0,123,255,.35);transition:background .2s,transform .05s}
    button:hover{background:var(--blue2)}button:active{transform:translateY(1px)}
    .ghost{background:#fff;color:var(--blue);border:1px solid #dcdcdc;box-shadow:none}
    .muted{color:var(--muted);font-size:14px;margin-top:6px}
    .ok{color:#118a2c;font-weight:700;margin-top:8px}
    .err{color:#c0392b;font-weight:700;margin-top:8px}
    iframe{width:100%;height:65vh;border:1px solid #eee;border-radius:10px;background:#fff;display:none;margin-top:10px}
    .pill{display:inline-block;background:#eef4ff;color:#1f4fd1;padding:6px 10px;border-radius:999px;font-size:13px}
    .list{margin-top:10px}
    .list .item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px dashed #eee}
    .item img{width:48px;height:48px;object-fit:cover;border-radius:8px;border:1px solid #eee}
    .item .meta{font-size:14px;color:#444}
    /* Admin */
    details.admin summary{cursor:pointer}
    .admin .row{margin-top:8px}
    textarea{width:100%;min-height:180px;border:1px solid #dcdcdc;border-radius:10px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace}
    .hint{font-size:12px;color:#888;margin-top:6px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .count{font-weight:700}
  </style>
</head>
<body>
  <header>
    <h1>חיפוש פריט / מק״ט + חיפוש באתר רנואר</h1>
  </header>

  <main class="wrap">
    <!-- شريط البحث -->
    <section class="card">
      <div class="row">
        <input id="q" type="text" placeholder="הכנס שם פריט או מק״ט">
        <button type="button" onclick="doLocal()">בדוק מחיר (מקומי)</button>
        <button type="button" class="ghost" onclick="searchInFrame()">חפש ברנואר (במסגרת)</button>
        <button type="button" class="ghost" onclick="openNew()">פתח בטאב חדש</button>
        <button type="button" class="ghost" onclick="openSame()">פתח באותו טאב</button>
        <button type="button" class="ghost" onclick="clearAll()">נקה</button>
      </div>
      <div id="msg" class="muted">טיפ: Enter يفحص السعر محليًا ويجهّز رابط רנואר.</div>
      <div id="priceBox"></div>
    </section>

    <!-- نتائج רנואר -->
    <section class="card">
      <strong>תוצאות באתר רנואר (במסגרת):</strong>
      <iframe id="renFrame" title="תוצאות חיפוש רנואר"></iframe>
      <div class="muted">إن لم يظهر داخل الإطار (بسبب سياسات IFRAME)، استخدم فتح في تبويب/نفس التبويب.</div>
    </section>

    <!-- نتائج قاعدة البيانات المحلية (من ملفك) -->
    <section class="card">
      <div class="pill">תוצאות בבסיס הנתונים המקומי</div>
      <div id="localList" class="list"></div>
      <div class="muted">هذه النتائج تأتي من الملف الذي ترفعه في لوحة المدير أدناه.</div>
    </section>

    <!-- لوحة مدير: رفع CSV/JSON وتخزينه محليًا -->
    <section class="card">
      <details class="admin">
        <summary><strong>لوحة المدير (تحميل/تحديث بيانات كل הפריטים)</strong></summary>
        <div class="toolbar">
          <input type="file" id="fileInput" accept=".csv,.json">
          <button class="ghost" type="button" onclick="importFile()">استيراد ملف</button>
          <button class="ghost" type="button" onclick="exportJSON()">تصدير JSON</button>
          <button class="ghost" type="button" onclick="wipe()">مسح كل البيانات</button>
          <span class="count">العناصر المخزّنة: <span id="cnt">0</span></span>
        </div>

        <div class="row">
          <textarea id="pasteBox" placeholder='ألصق هنا CSV أو JSON ثم اضغط "استيراد من النص"'></textarea>
        </div>
        <div class="toolbar">
          <button type="button" onclick="importFromText()">استيراد من النص</button>
          <button type="button" class="ghost" onclick="fillExample()">ملء مثال سريع</button>
        </div>
        <div class="hint">
          <div><strong>صيغة CSV المدعومة:</strong> عمود العناوين (أو أول سطر): <code>sku,name,price,link,img</code></div>
          <div>مثال: <code>123456,חולצת בייסיק,₪59.90,https://www.renuar.co.il/...,https://...</code></div>
          <div>صيغة JSON المدعومة: مصفوفة من كائنات: <code>[{"sku":"123","name":"שם","price":"₪X","link":"...","img":"..."}]</code></div>
          <div>تُخزَّن البيانات على المتصفّح (localStorage). لإضافة كل الكتالوج، استورد ملفًا كاملًا من نظامك/موردك.</div>
        </div>
      </details>
    </section>
  </main>

  <script>
    // ====== تخزين محلي ======
    const KEY = "CATALOG_FULL";
    const $ = id => document.getElementById(id);
    const input = $("q"), frame = $("renFrame"), msg = $("msg"), priceBox = $("priceBox"), list = $("localList"), cnt = $("cnt");

    function setMsg(cls,text){ msg.className=cls; msg.textContent=text; }
    function clearAll(){
      input.value=""; frame.removeAttribute("src"); frame.style.display="none";
      priceBox.textContent=""; list.innerHTML=""; setMsg("muted","تم المسح. اكتب اسم/מק״ט جديد.");
      input.focus();
    }

    // تنظيف الإدخال: أرقام/حروف/عبري ومسافات
    function stripHebrewNiqqud(s){ return s.replace(/[\u0591-\u05C7]/g,''); }
    function safeQuery(){
      let s = (input.value||"").trim();
      s = stripHebrewNiqqud(s).replace(/\s+/g," ").trim();
      s = s.replace(/[^\dA-Za-z\u0590-\u05FF\s\-]/g,"");
      return s;
    }

    // ====== بحث محلي ======
    function getDB(){
      try{ return JSON.parse(localStorage.getItem(KEY) || "[]"); }catch(_){ return []; }
    }
    function setDB(arr){
      localStorage.setItem(KEY, JSON.stringify(arr||[]));
      cnt.textContent = (arr||[]).length;
    }
    function refreshCount(){ cnt.textContent = getDB().length; }

    function searchLocal(q){
      const db = getDB();
      if(!q) return [];
      const s = q.trim();
      if(/^\d+$/.test(s)){
        return db.filter(p => (p.sku||"").toString().trim() === s);
      }
      const low = s.toLowerCase();
      return db.filter(p => (p.name||"").toLowerCase().includes(low));
    }

    function renderLocalResults(items){
      list.innerHTML = "";
      if(!items.length){ list.innerHTML = '<div class="muted">لا توجد نتائج في البيانات المحلية.</div>'; return; }
      const frag = document.createDocumentFragment();
      items.forEach(p=>{
        const div = document.createElement("div");
        div.className = "item";
        const img = document.createElement("img");
        img.src = p.img || "https://via.placeholder.com/80x80?text=IMG";
        img.alt = p.name || p.sku || "item";
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `<div><strong>${p.name||""}</strong></div>
                          <div>SKU: ${p.sku||"-"} — <strong>${p.price||"-"}</strong></div>
                          ${p.link? <div><a href="${p.link}" target="_blank" rel="noopener">فتح صفحة רנואר</a></div>:""}`;
        div.appendChild(img); div.appendChild(meta);
        frag.appendChild(div);
      });
      list.appendChild(frag);
    }

    function doLocal(){
      const q = safeQuery();
      if(!q){ setMsg("err","נא להזין שם פריט או מק״ט"); priceBox.textContent=""; list.innerHTML=""; return; }
      const items = searchLocal(q);
      if(items.length){
        const first = items[0];
        priceBox.className="ok";
        priceBox.textContent = 💰 ${first.price||"-"} — ${first.name||""} (SKU ${first.sku||"-"});
        renderLocalResults(items);
        setMsg("muted","نتائج من بياناتك المحلية.");
      }else{
        priceBox.className="err";
        priceBox.textContent = "ℹ غير موجود في بياناتك المحلية — استورد ملف المنتجات الكامل.";
        renderLocalResults([]);
        setMsg("muted","يمكنك دائمًا البحث في רנואר بالأزرار أعلاه.");
      }
    }

    // ====== رנואר ======
    function renUrl(q){ return "https://www.renuar.co.il/catalogsearch/result/?q="+encodeURIComponent(q); }
    function searchInFrame(){
      const q = safeQuery();
      if(!q){ setMsg("err","נא להזין שם פריט או מק״ט"); return; }
      frame.src = renUrl(q); frame.style.display="block";
      setMsg("muted","טוען תוצאות מרנואר…");
    }
    function openNew(){
      const q = safeQuery();
      if(!q){ setMsg("err","נא להזין שם פריט או מק״ט"); return; }
      window.open(renUrl(q), "_blank", "noopener");
    }
    function openSame(){
      const q = safeQuery();
      if(!q){ setMsg("err","נא להזין שם פריט או מק״ט"); return; }
      window.location.href = renUrl(q);
    }

    // Enter
    input.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); doLocal(); } });

    // ====== استيراد/تصدير ======
    function parseCSV(text){
      // بسيط: يفترض عنوان الأعمدة: sku,name,price,link,img
      const lines = text.trim().split(/\r?\n/);
      if(!lines.length) return [];
      // إذا السطر الأول عناوين—تجاوزه
      const head = lines[0].toLowerCase();
      let start = 0;
      if(head.includes("sku") && head.includes("name")) start = 1;
      const out = [];
      for(let i=start;i<lines.length;i++){
        const row = lines[i].split(",");
        if(!row.length) continue;
        const [sku,name,price,link,img] = row.map(s=> (s||"").trim());
        if(!sku && !name) continue;
        out.push({ sku, name, price, link, img });
      }
      return out;
    }

    function importFile(){
      const f = $("fileInput").files[0];
      if(!f){ alert("اختر ملفًا أولًا"); return; }
      const reader = new FileReader();
      reader.onload = e=>{
        let data = [];
        if(f.name.toLowerCase().endsWith(".json")){
          try{ data = JSON.parse(e.target.result||"[]"); }catch(err){ alert("JSON غير صالح"); return; }
        }else{
          data = parseCSV(e.target.result||"");
        }
        if(!Array.isArray(data)){ alert("البيانات يجب أن تكون مصفوفة"); return; }
        const db = getDB().concat(data);
        setDB(db);
        alert("تم الاستيراد: "+data.length+" عنصرًا");
      };
      reader.readAsText(f, "utf-8");
    }

    function importFromText(){
      const txt = $("pasteBox").value||"";
      let data = [];
      try{
        if(txt.trim().startsWith("[")) data = JSON.parse(txt);
        else data = parseCSV(txt);
      }catch(_){ alert("تنسيق غير صالح"); return; }
      if(!Array.isArray(data)){ alert("البيانات يجب أن تكون مصفوفة"); return; }
      const db = getDB().concat(data);
      setDB(db);
      alert("تم الاستيراد من النص: "+data.length+" عنصرًا");
    }

    function exportJSON(){
      const db = getDB();
      const blob = new Blob([JSON.stringify(db,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "catalog.json";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function wipe(){
      if(confirm("هل تريد مسح كل البيانات المحلية؟")){ setDB([]); alert("تم المسح"); }
    }

    function fillExample(){
      const example = [
        {"sku":"111","name":"חולצת בייסיק","price":"₪50","link":"","img":""},
        {"sku":"222","name":"מכנס ג׳ינס","price":"₪75","link":"","img":""},
        {"sku":"333","name":"שמלת ערב","price":"₪120","link":"","img":""},
        {"sku":"444","name":"מעיל חורף","price":"₪200","link":"","img":""}
      ];
      $("pasteBox").value = "sku,name,price,link,img\n111,חולצת בייסיק,₪50,,\n222,מכנס ג׳ינס,₪75,,\n333,שמלת ערב,₪120,,\n444,מעיל חורף,₪200,,";
      setDB(example);
      alert("تم ملء مثال سريع + تخزينه. يمكنك تعديل/إضافة كما تريد.");
    }

    // init
    refreshCount();
  </script>
</body>
</html>
