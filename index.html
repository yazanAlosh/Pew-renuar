<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>×¡×•×¨×§ ××§×´×˜ + ×—×™×¤×•×© ×¨× ×•××¨</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#007bff">

  <style>
    :root{--blue:#007bff;--blue-dark:#0056b3;--text:#222;--muted:#666;--bg:#f7f7f8;--card:#fff;--radius:14px}
    *{box-sizing:border-box} html,body{margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial;line-height:1.5;background:var(--bg);color:var(--text)}
    header{background:linear-gradient(90deg,var(--blue),var(--blue-dark));padding:16px 20px;text-align:center;color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.18)}
    header img{height:36px;vertical-align:middle}
    header h1{margin:8px 0 0;font-size:clamp(18px,2.6vw,26px)}
    .wrap{max-width:980px;margin:18px auto;padding:12px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.08);padding:clamp(14px,3vw,24px)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:stretch}
    input[type=text]{flex:1;min-width:220px;padding:12px;border:1px solid #dcdcdc;border-radius:10px;font-size:16px;outline:0;box-shadow:inset 0 2px 4px rgba(0,0,0,.03)}
    input[type=text]:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(0,123,255,.12), inset 0 2px 4px rgba(0,0,0,.03)}
    button{background:var(--blue);color:#fff;border:0;border-radius:10px;padding:12px 18px;font-size:16px;font-weight:600;cursor:pointer;box-shadow:0 6px 16px rgba(0,123,255,.35);transition:background .2s ease,transform .05s}
    button:hover{background:var(--blue-dark)} button:active{transform:translateY(1px)}
    .btn-ghost{background:#fff;color:var(--blue);border:1px solid #dcdcdc;box-shadow:none}
    .muted{color:var(--muted);font-size:14px;margin-top:6px}
    .grid{display:grid;gap:14px} @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
    iframe{width:100%;height:65vh;border:1px solid #e6e6e6;border-radius:10px;background:#fff}
    .ok{color:#118a2c;font-weight:700;margin-top:8px}
    .err{color:#c0392b;font-weight:700;margin-top:8px}

    /* Scanner modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:100}
    .modal .box{background:#000;color:#fff;border-radius:12px;width:min(680px,100%);padding:10px;position:relative}
    .modal header{background:transparent;box-shadow:none;padding:0 10px 6px;text-align:start}
    .close{position:absolute;top:10px;inset-inline-end:10px;background:#fff;color:#000;border:0;border-radius:8px;padding:8px 12px}
    video{width:100%;height:auto;border-radius:10px;background:#000}
  </style>
</head>
<body>
  <header>
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/69/Renuar_logo.png" alt="Renuar">
    <h1>×¡×•×¨×§ ××§×´×˜ + ×—×™×¤×•×© ×‘××ª×¨ ×¨× ×•××¨</h1>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="row">
        <input id="code" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="×”×›× ×¡ ××• ×¡×¨×•×§ ××§×´×˜">
        <button id="checkBtn">×‘×“×•×§ ××—×™×¨</button>
        <button id="searchBtn" class="btn-ghost">×—×¤×© ×‘×¨× ×•××¨</button>
        <button id="openBtn"   class="btn-ghost">×¤×ª×— ×‘×˜××‘ ×—×“×©</button>
        <button id="scanBtn">×¡×¨×•×§ ×¢× ××¦×œ××”</button>
        <button id="clearBtn" class="btn-ghost">× ×§×”</button>
      </div>
      <div id="msg" class="muted">×˜×™×¤: ×œ×—×™×¦×” ×¢×œ Enter ×ª×‘×“×•×§ ××—×™×¨ ×•×ª×‘×¦×¢ ×—×™×¤×•×©.</div>
    </section>

    <section class="grid">
      <div class="card">
        <strong>×ª×•×¦××•×ª ×‘××ª×¨ ×¨× ×•××¨ (×‘××¡×’×¨×ª):</strong>
        <iframe id="renFrame" title="×ª×•×¦××•×ª ×—×™×¤×•×© ×¨× ×•××¨" style="display:none;margin-top:10px;"></iframe>
        <div class="muted">×× ×œ× ××•×¤×™×¢ ×‘×ª×•×š ×”××¡×’×¨×ª, ×”×©×ª××© ×‘×›×¤×ª×•×¨ "×¤×ª×— ×‘×˜××‘ ×—×“×©" (×—×œ×§ ××”××ª×¨×™× ×—×•×¡××™× IFRAME).</div>
      </div>
      <div class="card">
        <strong>×˜×‘×œ×ª ××—×™×¨×™× ×œ×“×•×’××” (× ×™×ª×Ÿ ×œ×©× ×•×ª ×‘×§×•×“):</strong>
        <pre class="muted" style="white-space:pre-wrap;margin-top:8px">111 â†’ â‚ª50
222 â†’ â‚ª75
333 â†’ â‚ª120
444 â†’ â‚ª200</pre>
        <div id="priceRes"></div>
      </div>
    </section>
  </main>

  <!-- Scanner Modal -->
  <div id="scanModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="scanTitle">
    <div class="box">
      <header><h3 id="scanTitle" style="margin:6px 0">×¡×¨×™×§×ª ××§×´×˜</h3></header>
      <button id="closeScan" class="close">×¡×’×•×¨</button>
      <video id="preview" playsinline></video>
      <div id="scanHint" class="muted" style="color:#ddd;margin:6px 2px 0">×›×•×•×Ÿ ××ª ×”×‘×¨×§×•×“ ×œ××¨×›×– ×”××¡×š. ×‘×¨×’×¢ ×©×™×™×§×œ×˜, ×”××§×´×˜ ×™×•×–×Ÿ ××•×˜×•××˜×™×ª.</div>
    </div>
  </div>

  <script>
  "use strict";

  // Ø¬Ø¯ÙˆÙ„ Ø£Ø³Ø¹Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ â€” Ø¹Ø¯Ù‘Ù„Ù‡ ÙƒÙ…Ø§ ØªØ±ÙŠØ¯
  const prices = { "111":"â‚ª50", "222":"â‚ª75", "333":"â‚ª120", "444":"â‚ª200" };

  const $ = id => document.getElementById(id);
  const codeInput = $("code");
  const msg       = $("msg");
  const priceRes  = $("priceRes");
  const frame     = $("renFrame");
  const checkBtn  = $("checkBtn");
  const searchBtn = $("searchBtn");
  const openBtn   = $("openBtn");
  const scanBtn   = $("scanBtn");
  const clearBtn  = $("clearBtn");

  const scanModal = $("scanModal");
  const closeScan = $("closeScan");
  const video     = $("preview");
  const scanHint  = $("scanHint");

  let stream=null, detector=null, timer=null;

  function safeCode(){
    return (codeInput.value||"").trim().replace(/[^\dA-Za-z]/g,"");
  }
  function renUrl(c){ return https://www.renuar.co.il/catalogsearch/result/?q=${encodeURIComponent(c)}; }

  function showOk(text){ msg.className="ok"; msg.textContent=text; }
  function showErr(text){ msg.className="err"; msg.textContent=text; }
  function showMuted(text){ msg.className="muted"; msg.textContent=text; }

  function checkPrice(){
    const c = safeCode();
    if(!c){ showErr("× × ×œ×”×–×™×Ÿ ××§×´×˜"); return; }
    if(prices[c]){ priceRes.className="ok"; priceRes.textContent=ğŸ’° ×”××—×™×¨: ${prices[c]}; }
    else{ priceRes.className="err"; priceRes.textContent="âŒ ××§×´×˜ ×œ× × ××¦× ×‘×˜×‘×œ×”"; }
  }

  function searchRenuar(){
    const c = safeCode();
    if(!c){ showErr("× × ×œ×”×–×™×Ÿ ××§×´×˜"); return; }
    frame.src = renUrl(c);
    frame.style.display = "block";
    showMuted("×˜×•×¢×Ÿ ×ª×•×¦××•×ª ××¨× ×•××¨â€¦");
  }

  function openInNewTab(){
    const c = safeCode();
    if(!c){ showErr("× × ×œ×”×–×™×Ÿ ××§×´×˜"); return; }
    window.open(renUrl(c), "_blank", "noopener");
  }

  function clearAll(){
    codeInput.value="";
    frame.removeAttribute("src");
    frame.style.display="none";
    priceRes.textContent="";
    showMuted("×˜×™×¤: ×œ×—×™×¦×” ×¢×œ Enter ×ª×‘×“×•×§ ××—×™×¨ ×•×ª×‘×¦×¢ ×—×™×¤×•×©.");
    codeInput.focus();
  }

  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  checkBtn.onclick  = checkPrice;
  searchBtn.onclick = searchRenuar;
  openBtn.onclick   = openInNewTab;
  clearBtn.onclick  = clearAll;

  // Enter ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„Ø£Ù…Ø±ÙŠÙ†
  codeInput.addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){ e.preventDefault(); checkPrice(); searchRenuar(); }
  });

  // Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: BarcodeDetector Ø¥Ù† ÙˆÙØ¬Ø¯
  async function openScanner(){
    try{
      scanModal.style.display="flex";
      stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" } });
      video.srcObject = stream; await video.play();

      if("BarcodeDetector" in window){
        const formats = ["ean_13","ean_8","code_128","code_39","upc_a","upc_e","itf","qr_code"];
        detector = new BarcodeDetector({ formats });
        timer = setInterval(async ()=>{
          try{
            const codes = await detector.detect(video);
            if(codes && codes.length){
              const val = codes[0].rawValue || codes[0].displayValue;
              if(val){
                codeInput.value = val;
                closeScanner(false);
                checkPrice(); searchRenuar();
              }
            }
          }catch(_){}
        }, 180);
      }else{
        scanHint.textContent = "×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×–×™×”×•×™ ×‘×¨×§×•×“. ×”×–×Ÿ ××§×´×˜ ×™×“× ×™×ª.";
      }
    }catch(e){
      alert("××™×Ÿ ×’×™×©×” ×œ××¦×œ××”. ×•×“× ×©×”×¢××•×“ ×‘-HTTPS (GitHub Pages) ×•×”×”×¨×©××” ×××•×©×¨×ª.");
      closeScanner(true);
    }
  }
  function closeScanner(skipStop){
    scanModal.style.display="none";
    if(timer){ clearInterval(timer); timer=null; }
    if(!skipStop && stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  }
  scanBtn.onclick   = openScanner;
  closeScan.onclick = ()=> closeScanner(false);
  scanModal.addEventListener("click",(e)=>{ if(e.target===scanModal) closeScanner(false); });

  // ØªØ³Ø¬ÙŠÙ„ Service Worker Ù„Ù„Ù€PWA (ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ HTTPS/GitHub Pages)
  if("serviceWorker" in navigator){
    window.addEventListener("load",()=> navigator.serviceWorker.register("./sw.js").catch(()=>{}));
  }
  </script>
</body>
</html>
